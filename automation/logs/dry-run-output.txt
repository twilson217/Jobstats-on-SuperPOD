BCM Jobstats Deployment - Dry Run Commands
==================================================

  1. which cmsh
  2. cmsh -c 'wlm;get prolog;get epilog;get epilogslurmctld'
  3. cmsh -c 'wlm;use slurm;show' | grep -E '(prolog|epilog)'
  4. ssh lab-slurm-controller 'apt update'
  5. ssh lab-slurm-controller 'apt install -y python3-requests python3-blessed'
  6. ssh lab-slurm-controller 'mkdir -p /opt/jobstats-deployment'
  7. ssh lab-slurm-controller 'test -d /opt/jobstats-deployment/jobstats'
  8. ssh lab-slurm-controller 'cd /opt/jobstats-deployment/jobstats && git pull'
  9. ssh lab-slurm-controller 'mkdir -p /cm/shared/apps/slurm/var/cm'
 10. ssh lab-slurm-controller 'cp /opt/jobstats-deployment/jobstats/jobstats/slurm/prolog.d/gpustats_helper.sh /cm/shared/apps/slurm/var/cm/prolog-jobstats.sh'
 11. ssh lab-slurm-controller 'chmod +x /cm/shared/apps/slurm/var/cm/prolog-jobstats.sh'
 12. ssh lab-slurm-controller 'cp /opt/jobstats-deployment/jobstats/jobstats/slurm/epilog.d/gpustats_helper.sh /cm/shared/apps/slurm/var/cm/epilog-jobstats.sh'
 13. ssh lab-slurm-controller 'chmod +x /cm/shared/apps/slurm/var/cm/epilog-jobstats.sh'
 14. ssh lab-slurm-controller 'mkdir -p /cm/local/apps/slurm/var/prologs'
 15. ssh lab-slurm-controller 'mkdir -p /cm/local/apps/slurm/var/epilogs'
 16. ssh lab-slurm-controller 'ln -sf /cm/shared/apps/slurm/var/cm/prolog-jobstats.sh /cm/local/apps/slurm/var/prologs/60-prolog-jobstats.sh'
 17. ssh lab-slurm-controller 'ln -sf /cm/shared/apps/slurm/var/cm/epilog-jobstats.sh /cm/local/apps/slurm/var/epilogs/60-epilog-jobstats.sh'
 18. ssh lab-slurm-controller 'cp /opt/jobstats-deployment/jobstats/jobstats/slurm/slurmctldepilog.sh /usr/local/sbin/'
 19. ssh lab-slurm-controller 'chmod +x /usr/local/sbin/slurmctldepilog.sh'
 20. ssh lab-slurm-controller 'mkdir -p /opt/jobstats-deployment'
 21. ssh lab-slurm-controller 'test -d /opt/jobstats-deployment/jobstats'
 22. ssh lab-slurm-controller 'cd /opt/jobstats-deployment/jobstats && git pull'
 23. ssh lab-slurm-controller 'cp /opt/jobstats-deployment/jobstats/jobstats/jobstats /usr/local/bin/'
 24. ssh lab-slurm-controller 'cp /opt/jobstats-deployment/jobstats/jobstats/jobstats.py /usr/local/bin/'
 25. ssh lab-slurm-controller 'cp /opt/jobstats-deployment/jobstats/jobstats/output_formatters.py /usr/local/bin/'
 26. ssh lab-slurm-controller 'cp /opt/jobstats-deployment/jobstats/jobstats/config.py /usr/local/bin/'
 27. ssh lab-slurm-controller 'chmod +x /usr/local/bin/jobstats'
 28. ssh dgx-node-01 'apt update'
 29. ssh dgx-node-01 'apt install -y golang-go build-essential'
 30. ssh dgx-node-01 'mkdir -p /opt/jobstats-deployment'
 31. ssh dgx-node-01 'test -d /opt/jobstats-deployment/cgroup_exporter'
 32. ssh dgx-node-01 'cd /opt/jobstats-deployment/cgroup_exporter && git pull'
 33. ssh dgx-node-01 'test -d /opt/jobstats-deployment/nvidia_gpu_prometheus_exporter'
 34. ssh dgx-node-01 'cd /opt/jobstats-deployment/nvidia_gpu_prometheus_exporter && git pull'
 35. ssh dgx-node-01 'test -d /opt/jobstats-deployment/node_exporter'
 36. ssh dgx-node-01 'cd /opt/jobstats-deployment/node_exporter && git pull'
 37. ssh dgx-node-01 'cd /opt/jobstats-deployment/cgroup_exporter && go build -o cgroup_exporter'
 38. ssh dgx-node-01 'cp /opt/jobstats-deployment/cgroup_exporter/cgroup_exporter /usr/local/bin/'
 39. ssh dgx-node-01 'cd /opt/jobstats-deployment/nvidia_gpu_prometheus_exporter && go build -o nvidia_gpu_prometheus_exporter'
 40. ssh dgx-node-01 'cp /opt/jobstats-deployment/nvidia_gpu_prometheus_exporter/nvidia_gpu_prometheus_exporter /usr/local/bin/'
 41. ssh dgx-node-01 'cd /opt/jobstats-deployment/node_exporter && make build'
 42. ssh dgx-node-01 'cp /opt/jobstats-deployment/node_exporter/node_exporter /usr/local/bin/'
 43. ssh dgx-node-01 'useradd --no-create-home --shell /bin/false prometheus || true'
 44. ssh dgx-node-01 'cp /tmp/tmpcchl5e8f /etc/systemd/system/cgroup_exporter.service'
 45. ssh dgx-node-01 'cp /tmp/tmpw8d2ro6u /etc/systemd/system/node_exporter.service'
 46. ssh dgx-node-01 'cp /tmp/tmpthq7qryw /etc/systemd/system/nvidia_gpu_prometheus_exporter.service'
 47. ssh dgx-node-01 'systemctl daemon-reload'
 48. ssh dgx-node-01 'systemctl enable cgroup_exporter'
 49. ssh dgx-node-01 'systemctl start cgroup_exporter'
 50. ssh dgx-node-01 'systemctl daemon-reload'
 51. ssh dgx-node-01 'systemctl enable node_exporter'
 52. ssh dgx-node-01 'systemctl start node_exporter'
 53. ssh dgx-node-01 'systemctl daemon-reload'
 54. ssh dgx-node-01 'systemctl enable nvidia_gpu_prometheus_exporter'
 55. ssh dgx-node-01 'systemctl start nvidia_gpu_prometheus_exporter'
 56. ssh dgx-node-02 'apt update'
 57. ssh dgx-node-02 'apt install -y golang-go build-essential'
 58. ssh dgx-node-02 'mkdir -p /opt/jobstats-deployment'
 59. ssh dgx-node-02 'test -d /opt/jobstats-deployment/cgroup_exporter'
 60. ssh dgx-node-02 'cd /opt/jobstats-deployment/cgroup_exporter && git pull'
 61. ssh dgx-node-02 'test -d /opt/jobstats-deployment/nvidia_gpu_prometheus_exporter'
 62. ssh dgx-node-02 'cd /opt/jobstats-deployment/nvidia_gpu_prometheus_exporter && git pull'
 63. ssh dgx-node-02 'test -d /opt/jobstats-deployment/node_exporter'
 64. ssh dgx-node-02 'cd /opt/jobstats-deployment/node_exporter && git pull'
 65. ssh dgx-node-02 'cd /opt/jobstats-deployment/cgroup_exporter && go build -o cgroup_exporter'
 66. ssh dgx-node-02 'cp /opt/jobstats-deployment/cgroup_exporter/cgroup_exporter /usr/local/bin/'
 67. ssh dgx-node-02 'cd /opt/jobstats-deployment/nvidia_gpu_prometheus_exporter && go build -o nvidia_gpu_prometheus_exporter'
 68. ssh dgx-node-02 'cp /opt/jobstats-deployment/nvidia_gpu_prometheus_exporter/nvidia_gpu_prometheus_exporter /usr/local/bin/'
 69. ssh dgx-node-02 'cd /opt/jobstats-deployment/node_exporter && make build'
 70. ssh dgx-node-02 'cp /opt/jobstats-deployment/node_exporter/node_exporter /usr/local/bin/'
 71. ssh dgx-node-02 'useradd --no-create-home --shell /bin/false prometheus || true'
 72. ssh dgx-node-02 'cp /tmp/tmp864glarh /etc/systemd/system/cgroup_exporter.service'
 73. ssh dgx-node-02 'cp /tmp/tmp6m5ltipp /etc/systemd/system/node_exporter.service'
 74. ssh dgx-node-02 'cp /tmp/tmpwq1qp_77 /etc/systemd/system/nvidia_gpu_prometheus_exporter.service'
 75. ssh dgx-node-02 'systemctl daemon-reload'
 76. ssh dgx-node-02 'systemctl enable cgroup_exporter'
 77. ssh dgx-node-02 'systemctl start cgroup_exporter'
 78. ssh dgx-node-02 'systemctl daemon-reload'
 79. ssh dgx-node-02 'systemctl enable node_exporter'
 80. ssh dgx-node-02 'systemctl start node_exporter'
 81. ssh dgx-node-02 'systemctl daemon-reload'
 82. ssh dgx-node-02 'systemctl enable nvidia_gpu_prometheus_exporter'
 83. ssh dgx-node-02 'systemctl start nvidia_gpu_prometheus_exporter'
 84. ssh lab-monitoring 'apt update'
 85. ssh lab-monitoring 'apt install -y wget gnupg'
 86. ssh lab-monitoring 'apt update'
 87. ssh lab-monitoring 'apt install -y wget'
 88. ssh lab-monitoring 'wget https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz'
 89. ssh lab-monitoring 'tar xzf prometheus-2.45.0.linux-amd64.tar.gz'
 90. ssh lab-monitoring 'cp prometheus-2.45.0.linux-amd64/prometheus /usr/local/bin/'
 91. ssh lab-monitoring 'cp prometheus-2.45.0.linux-amd64/promtool /usr/local/bin/'
 92. ssh lab-monitoring 'mkdir -p /etc/prometheus /var/lib/prometheus'
 93. ssh lab-monitoring 'useradd --no-create-home --shell /bin/false prometheus || true'
 94. ssh lab-monitoring 'chown prometheus:prometheus /var/lib/prometheus'
 95. cmsh -c 'show' | head -1
 96. ssh lab-monitoring 'cp /tmp/tmp_r1_9kgt /etc/prometheus/prometheus.yml'
 97. ssh lab-monitoring 'chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus'
 98. ssh lab-monitoring 'cp /tmp/tmpj94dorvy /etc/systemd/system/prometheus.service'
 99. ssh lab-monitoring 'systemctl daemon-reload'
100. ssh lab-monitoring 'systemctl enable prometheus'
101. ssh lab-monitoring 'systemctl start prometheus'
102. ssh lab-monitoring 'wget -q -O - https://packages.grafana.com/gpg.key | apt-key add -'
103. ssh lab-monitoring 'echo "deb https://packages.grafana.com/oss/deb stable main" > /etc/apt/sources.list.d/grafana.list'
104. ssh lab-monitoring 'apt update'
105. ssh lab-monitoring 'apt install -y grafana'
106. ssh lab-monitoring 'systemctl enable grafana-server'
107. ssh lab-monitoring 'systemctl start grafana-server'
